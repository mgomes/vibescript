package main

import (
	"context"
	"time"

	"github.com/mgomes/vibescript/vibes"
)

func main() {
	engine, err := vibes.NewEngine(vibes.Config{
		StepQuota:        50_000,
		MemoryQuotaBytes: 512 << 10,
		RecursionLimit:   64,
		StrictEffects:    true,
	})
	if err != nil {
		panic(err)
	}

	script, err := engine.Compile(`
def run(batch_id: string) -> hash
  {
    batch_id: batch_id,
    processed_at: Time.now.format("2006-01-02 15:04:05"),
  }
end
`)
	if err != nil {
		panic(err)
	}

	ticker := time.NewTicker(5 * time.Minute)
	defer ticker.Stop()

	for range ticker.C {
		_, err := script.Call(context.Background(), "run", []vibes.Value{
			vibes.NewString("nightly-batch"),
		}, vibes.CallOptions{})
		if err != nil {
			panic(err)
		}
	}
}
