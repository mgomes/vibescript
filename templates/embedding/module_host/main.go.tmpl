package main

import (
	"context"
	"path/filepath"

	"github.com/mgomes/vibescript/vibes"
)

func main() {
	modulesDir, err := filepath.Abs("./workflows")
	if err != nil {
		panic(err)
	}

	engine, err := vibes.NewEngine(vibes.Config{
		StepQuota:        25_000,
		MemoryQuotaBytes: 256 << 10,
		RecursionLimit:   48,
		StrictEffects:    true,
		ModulePaths:      []string{modulesDir},
		ModuleAllowList:  []string{"public/*"},
		ModuleDenyList:   []string{"public/internal/*"},
	})
	if err != nil {
		panic(err)
	}

	script, err := engine.Compile(`
def run(amount: int) -> int
  fees = require("public/fees")
  fees.apply(amount)
end
`)
	if err != nil {
		panic(err)
	}

	_, err = script.Call(context.Background(), "run", []vibes.Value{
		vibes.NewInt(1000),
	}, vibes.CallOptions{})
	if err != nil {
		panic(err)
	}
}
