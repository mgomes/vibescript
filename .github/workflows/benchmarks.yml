name: benchmarks

on:
  push:
    branches: [master]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1"

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Configure benchmark profile
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "BENCH_COUNT=1" >> "$GITHUB_ENV"
            echo "BENCH_TIME=2s" >> "$GITHUB_ENV"
            echo "BENCH_BASELINE=benchmarks/baselines/v0.20.0-full.txt" >> "$GITHUB_ENV"
            echo "BENCH_PROFILE=full" >> "$GITHUB_ENV"
          else
            echo "BENCH_COUNT=1" >> "$GITHUB_ENV"
            echo "BENCH_TIME=1s" >> "$GITHUB_ENV"
            echo "BENCH_BASELINE=benchmarks/baselines/v0.20.0-pr.txt" >> "$GITHUB_ENV"
            echo "BENCH_PROFILE=pr" >> "$GITHUB_ENV"
          fi

      - name: Benchmark smoke gates
        if: github.event_name != 'schedule'
        run: |
          set -o pipefail
          mkdir -p .bench
          ./scripts/bench_smoke_check.sh | tee .bench/smoke.txt

      - name: Run benchmarks
        run: |
          mkdir -p .bench
          scripts/bench_runtime.sh \
            --count "$BENCH_COUNT" \
            --benchtime "$BENCH_TIME" \
            --out ".bench/benchmark-$BENCH_PROFILE.txt"

      - name: Compare benchmark trend against baseline
        run: |
          ./scripts/bench_compare_baseline.sh \
            "$BENCH_BASELINE" \
            ".bench/benchmark-$BENCH_PROFILE.txt" | tee ".bench/trend-$BENCH_PROFILE.txt"

      - name: Publish benchmark summary
        run: |
          {
            if [[ -f .bench/smoke.txt ]]; then
              echo "## Benchmark Smoke Gates"
              echo ""
              echo '```text'
              cat .bench/smoke.txt
              echo '```'
              echo ""
            fi
            echo "## Benchmark Trend vs Baseline ($BENCH_PROFILE)"
            echo ""
            echo '```text'
            cat ".bench/trend-$BENCH_PROFILE.txt"
            echo '```'
            echo ""
            echo "## Benchmark Results ($BENCH_PROFILE)"
            echo ""
            echo '```text'
            cat ".bench/benchmark-$BENCH_PROFILE.txt"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload benchmark artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.event_name }}-${{ github.run_number }}
          path: |
            .bench/benchmark-*.txt
            .bench/trend-*.txt
            .bench/smoke.txt
          if-no-files-found: warn
